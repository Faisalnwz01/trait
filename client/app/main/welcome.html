<head><title>User Modeling Demonstration</title><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/css/watson-bootstrap-dark.css"><link rel="stylesheet" href="/css/browser-compatibility.css"><link rel="stylesheet" href="/css/watson-code.css"><link rel="stylesheet" href="/css/style.css"></head>
<div ng-include="'components/navbar/navbar.html'"></div>
<!-- <div class="row">
			<div class="col-md-3 educationFormal">
						<h2>EXPERIENCE</h2>
			</div>
			<div ng-repeat="position in profileInformation.linkedin.positions.values">
						<div class="col-md-3 educationFormal">
						</div>
						<div class="col-md-7">
									<div class='bold'><strong>{{position.company.name}}</strong>
									</div>
									<div><i>{{position.title}}</i>
									</div>
									<br>
									<div>{{position.summary}}
									</div>
									<br>
						</div>
						
			</div>
</div> -->


{{profileInformation.watsonData[0].tree}}
<!-- 
<h2>Big Five</h2>
<div ng-repeat = 'trait in profileInformation.watsonData[0].tree.children[0].children[0].children[0].children'>
{{trait.name}}
{{trait.percentage | percentage}}
</div>
<div ng-repeat = 'trait3 in profileInformation.watsonData[0].tree.children[0].children[1].children[0].children'>
{{trait3.name}}
{{trait3.percentage | percentage}}
</div>
<h2>Needs</h2>
<div ng-repeat = 'trait1 in profileInformation.watsonData[0].tree.children[1].children[0].children'>
{{trait1.name}}
{{trait1.percentage | percentage}}
</div>
<h2>values</h2>
<div ng-repeat = 'trait2 in profileInformation.watsonData[0].tree.children[2].children[0].children'>
{{trait2.name}}
{{trait2.percentage | percentage}}

 -->


<script type="text/javascript">

	var widgetId = "chartDiv";
	var widgetWidth = 900;
	var widgetHeight = 900;
	var theProfile = {"children":[{"children":[{"children":[{"size":1,"children":[{"size":1,"percentage":0.99,"category":"personality","name":"Adventurousness","id":"Adventurousness"},{"size":1,"percentage":0.32,"category":"personality","name":"Artistic interests","id":"Artistic interests"},{"size":1,"percentage":0.03,"category":"personality","name":"Emotionality","id":"Emotionality"},{"size":1,"percentage":1,"category":"personality","name":"Imagination","id":"Imagination"},{"size":1,"percentage":1,"category":"personality","name":"Intellect","id":"Intellect"},{"size":1,"percentage":1,"category":"personality","name":"Liberalism","id":"Liberalism"}],"percentage":1,"category":"personality","name":"Openness","id":"Openness"},{"size":1,"children":[{"size":1,"percentage":1,"category":"personality","name":"Achievement striving","id":"Achievement striving"},{"size":1,"percentage":0.98,"category":"personality","name":"Cautiousness","id":"Cautiousness"},{"size":1,"percentage":0.42,"category":"personality","name":"Dutifulness","id":"Dutifulness"},{"size":1,"percentage":0.01,"category":"personality","name":"Orderliness","id":"Orderliness"},{"size":1,"percentage":0.55,"category":"personality","name":"Self-discipline","id":"Self-discipline"},{"size":1,"percentage":0.77,"category":"personality","name":"Self-efficacy","id":"Self-efficacy"}],"percentage":0.82,"category":"personality","name":"Conscientiousness","id":"Conscientiousness"},{"size":1,"children":[{"size":1,"percentage":1,"category":"personality","name":"Activity level","id":"Activity level"},{"size":1,"percentage":0.03,"category":"personality","name":"Assertiveness","id":"Assertiveness"},{"size":1,"percentage":0.02,"category":"personality","name":"Cheerfulness","id":"Cheerfulness"},{"size":1,"percentage":0.01,"category":"personality","name":"Excitement-seeking","id":"Excitement-seeking"},{"size":1,"percentage":0.03,"category":"personality","name":"Friendliness","id":"Friendliness"},{"size":1,"percentage":0.03,"category":"personality","name":"Gregariousness","id":"Gregariousness"}],"percentage":0.01,"category":"personality","name":"Extraversion","id":"Extraversion"},{"size":1,"children":[{"size":1,"percentage":0.29,"category":"personality","name":"Altruism","id":"Altruism"},{"size":1,"percentage":0.86,"category":"personality","name":"Cooperation","id":"Cooperation"},{"size":1,"percentage":0.12,"category":"personality","name":"Modesty","id":"Modesty"},{"size":1,"percentage":0.09,"category":"personality","name":"Morality","id":"Morality"},{"size":1,"percentage":1,"category":"personality","name":"Sympathy","id":"Sympathy"},{"size":1,"percentage":0.31,"category":"personality","name":"Trust","id":"Trust"}],"percentage":0.03,"category":"personality","name":"Agreeableness","id":"Agreeableness"},{"size":1,"children":[{"size":1,"percentage":0.32,"category":"personality","name":"Anger","id":"Anger"},{"size":1,"percentage":0.18,"category":"personality","name":"Anxiety","id":"Anxiety"},{"size":1,"percentage":0.63,"category":"personality","name":"Depression","id":"Depression"},{"size":1,"percentage":0.05,"category":"personality","name":"Immoderation","id":"Immoderation"},{"size":1,"percentage":1,"category":"personality","name":"Self-consciousness","id":"Self-consciousness"},{"size":1,"percentage":0.44,"category":"personality","name":"Vulnerability","id":"Vulnerability"}],"percentage":0.46,"category":"personality","name":"Neuroticism","id":"Neuroticism"}],"percentage":1,"category":"personality","name":"Openness","id":"Openness_parent"}],"name":"Big 5","id":"personality"},{"children":[{"children":[{"size":1,"percentage":0.61,"category":"needs","name":"Challenge","id":"Challenge"},{"size":1,"percentage":0.96,"category":"needs","name":"Closeness","id":"Closeness"},{"size":1,"percentage":0.51,"category":"needs","name":"Curiosity","id":"Curiosity"},{"size":1,"percentage":0.68,"category":"needs","name":"Excitement","id":"Excitement"},{"size":1,"percentage":0.94,"category":"needs","name":"Harmony","id":"Harmony"},{"size":1,"percentage":0.38,"category":"needs","name":"Ideal","id":"Ideal"},{"size":1,"percentage":0.51,"category":"needs","name":"Liberty","id":"Liberty"},{"size":1,"percentage":0.04,"category":"needs","name":"Love","id":"Love"},{"size":1,"percentage":0.86,"category":"needs","name":"Practicality","id":"Practicality"},{"size":1,"percentage":0.38,"category":"needs","name":"Self-expression","id":"Self-expression"},{"size":1,"percentage":0.6,"category":"needs","name":"Stability","id":"Stability"},{"size":1,"percentage":0.31,"category":"needs","name":"Structure","id":"Structure"}],"percentage":0.04,"category":"needs","name":"Love","id":"Love_parent"}],"name":"Needs","id":"needs"},{"children":[{"children":[{"size":1,"percentage":0.02,"category":"values","name":"Conservation","id":"Conservation"},{"size":1,"percentage":0.56,"category":"values","name":"Openness to change","id":"Openness to change"},{"size":1,"percentage":0.01,"category":"values","name":"Hedonism","id":"Hedonism"},{"size":1,"percentage":1,"category":"values","name":"Self-enhancement","id":"Self-enhancement"},{"size":1,"percentage":0.01,"category":"values","name":"Self-transcendence","id":"Self-transcendence"}],"percentage":1,"category":"values","name":"Self-enhancement","id":"Self-enhancement_parent"}],"name":"Values","id":"values"}],"name":"root","id":"r"};
	var personImageUrl = "\/images\/app.png";
	console.log('hit')

</script>

	<script type="text/javascript">
	  d3.svg.singleArc = function() {
		  var radius = d3_svg_singleArcRadius,
		      startAngle = d3_svg_singleArcStartAngle,
		      endAngle = d3_svg_singleArcEndAngle;
		  var d3_svg_arcOffset = -Math.PI / 2, d3_svg_arcMax = 2 * Math.PI - 1e-6;
		  function arc() {
		    var r0 = radius.apply(this, arguments),
		        a0 = startAngle.apply(this, arguments) + d3_svg_arcOffset,
		        a1 = endAngle.apply(this, arguments) + d3_svg_arcOffset,
		        da = (a1 < a0 && (da = a0, a0 = a1, a1 = da), a1 - a0),
		        df = da < Math.PI ? "0" : "1",
		        c0 = Math.cos(a0),
		        s0 = Math.sin(a0),
		        c1 = Math.cos(a1),
		        s1 = Math.sin(a1);
		    return "M" + r0 * c0 + "," + r0 * s0
		      + "A" + r0 + "," + r0 + " 0 " + df + ",1 " + r0 * c1 + "," + r0 * s1;
		  }

		  arc.radius = function(v) {
		    if (!arguments.length) return radius;
		    radius = d3.functor(v);
		    return arc;
		  };

		  arc.startAngle = function(v) {
		    if (!arguments.length) return startAngle;
		    startAngle = d3.functor(v);
		    return arc;
		  };

		  arc.endAngle = function(v) {
		    if (!arguments.length) return endAngle;
		    endAngle = d3.functor(v);
		    return arc;
		  };

		  arc.centroid = function() {
		    var r = radius.apply(this, arguments),
		        a = (startAngle.apply(this, arguments)
		        + endAngle.apply(this, arguments)) / 2 + d3_svg_arcOffset;
		    return [Math.cos(a) * r, Math.sin(a) * r];
		  };

		  return arc;
		};

		function d3_svg_singleArcRadius(d) {
		  return d.radius;
		}

		function d3_svg_singleArcStartAngle(d) {
		  return d.startAngle;
		}

		function d3_svg_singleArcEndAngle(d) {
		  return d.endAngle;
		}

	var visutil = {
	 isLocatedBottom: function(d) {
            // Before fixing #128: return (d.x>Math.PI/2&&(d.x+d.dx)<Math.PI*5/3);
        	var bottom = (d.x>Math.PI/2 && (d.x+d.dx)<5.0);
        	// The procedure to decide how to position text (upside down or not) IS very ad hoc. This helps debugging:19
        	//if (d.id=="Thursday_parent" || d.id=="SelfEnhancement_parent") {
        	//		console.log("isLocatedBottom", d.id, d.x, d.dx, d.x+d.dx, bottom);
        	//}
            return bottom;
        },
	
        arc: function(start,end,r0 ) {
            var c0 = Math.cos(start),
                s0 = Math.sin(start),
                c1 = Math.cos(end),
                s1 = Math.sin(end);
            return "M" + r0 * c0 + "," + r0 * s0
              + "A" + r0 + "," + r0 + " 0" + " 0 , 0 " + r0 * c1 + "," + r0 * s1;
        }
     };

    var renderChart = function() {
            if (!this.data) {
                this.showError();
                return;
            }
            if (this.vis) {
            	console.error("Cannot render: Already rendered (this.vis)");
            	return;
            }

            var _this = this;
            var dummyData = false;
            var tree = this.data ? (this.data.tree ? this.data.tree : this.data) : null;
            if (!tree || !tree.children || !tree.children.length) {
            	return;
            }
            
            var _widget = this;
            if (!this.loadingDiv) {
                    alert("Widget is not fully initialized, cannot render BarsWidget");
                    return;
            }
            
            this.switchState(1);
            this._layout();
        	function stash(d) {
        		  d.x0 = d.x;
        		  d.dx0 = d.dx;
        		  d.size0=d.size;
        		  if (d.depth==0 || d.depth==1) {
        			  d.expand=1;
        		  } else {
        			  d.expand=0;
        		  }
        	}
        	
		  	function expandOrFoldSector(d) {
		   		if (d.expand!=null && d.depth>1){
		   			//ignore root node and first level sectors
		   		if (d.expand==0){
		   			//if the sector is folded
		   			 // update_anglefactor(d, d.anglefactor+1);
		   			  // g.data(partition.value(function(a) { 			    	
			        		// return a.size; 
			        	// }))
			        // .call(sector);
				     if(d.children) d3.select(this).attr("opacity",1);
				  		 g.filter(function(a) {
							if (a.parent) 
							return  a.parent.id==d.id;
							})
				        	.attr("visibility","visible");
		        		d.expand=1;
		        } else {
		      		//if the sector is expanded
		      			
				      // update_anglefactor(d, d.anglefactor-1);
				      // g.data(partition.value(function(a) { 			    	
			        		// return a.size; 
			        	// }))
			        // .call(sector);
			          if(d.children) d3.select(this).attr("opacity",1);
				      hideSector(d);
				      
		      		}
		      	}
		   }

		   function hideSector(d){
				g.filter(function(a) {
					if (a.parent) 
						return  a.parent.id==d.id;
					})
		        	.attr("visibility","hidden")
		        	.attr("opacity",1)
		        	.each(function(a){
		        		if (a.children)
		        			hideSector(a);
		        		});
		        d.expand=0;
			}

        	
            var sector_right_pad=dummyData ? 0.0001 : 0.04*2 * Math.PI, sector_bottom_pad=5.0;
            //Render a sector with two adjcent arcs in a style of odometor
            function twoArcsRender(radius) {
              // For each small multiple
              function twoArcs(g) {
                g.each(function(d) {
                	 g = d3.select(this);
                     g.selectAll("path").remove();
                     g.selectAll("text").remove();
                     
                     var right_pad= d.depth>0 ? sector_right_pad/(3*d.depth): sector_right_pad;
                               	
            		var percentage=d.percentage,
            			percentage2=1;//for percentage sentiment data. it is the percentage of positive+netural
            			
            		//if percentage is null, then give 1
            		if(percentage==null) percentage=1;
                    if(d.percentage_lbl==null) d.percentage_lbl=""; 
            	   var label, label_name=d.name, 
							label_percentage = (d.percentage==null? "": " ("+(d.percentage*100).toFixed(0)+"%)");
                   
                   if (d.depth==1) label=d.name;
                   if (d.depth>1){
            	        if (d.id=="sbh_dom"){
        	        		label=d.name;
            	        } else if (d.category=="values") { 
            	             label=d.name+" ("+(percentage*100).toFixed(0)+"%)";
            	        } else {
            	        		 if(percentage>=1) {
            	        		 	percentage=0.99;
            			         	console.error("Percentage is over 1!"+d.name);
            			         } else if (percentage<=-1) {
        			 				percentage=-0.99;
        			         		console.log("Percentage is below -1!"+d.name);
            			         }        		
        	        			label=d.name+" ("+(percentage*100).toFixed(0)+"%)";
            	        		
            	        		if ((Math.round(parseFloat(percentage)*100)/100)==0) {  
            	        			label=d.name;
            	        		}
            	        }
                    }  
                    
                    //for request without any result
                    if(d.name=="") {
                    	percentage=0; 
                    	label="";
                    }

            		//special render perception sector 
                    if (d.perc_neu!=null && ((d.percentage+d.perc_neu)*d.dx<d.dx-sector_right_pad/(3*d.depth))){
                    	percentage2=d.percentage+d.perc_neu;
                    		
                    	d3.svg.arc()
            			    .startAngle(function(d) {
            			    	 return d.x +Math.abs(percentage2)*d.dx; 
        			    	 })//x:startangle,
            			    .endAngle(function(d) { return d.x + d.dx-sector_right_pad/(3*d.depth); })//dx: endangle,
            			    .innerRadius(function(d) { return sector_bottom_pad+d.y; })
            			    .outerRadius(function(d) { return d.y + d.dy; });
            			
            			right_pad=0;    
                    }

                    	
                    var arc1_extend=(Math.abs(percentage)*d.dx-right_pad)>0? (Math.abs(percentage)*d.dx-right_pad):0;	
                    //Regular renders
                     var arc1 = d3.svg.arc()
            			    .startAngle(function(d) { return d.x; })//x:startangle,
            			    .endAngle(function(d) { return d.x + arc1_extend; })//dx: endangle,
            			    .innerRadius(function(d) { return sector_bottom_pad+d.y; })
            			    .outerRadius(function(d) { return d.y + d.dy; });
            			          
             		var arc2 = d3.svg.arc()
            			     .startAngle(function(d) { return d.x +arc1_extend; })//x:startangle,
            			    .endAngle(function(d) { return d.x + Math.abs(percentage2)*d.dx-right_pad; })//dx: endangle,
            			    .innerRadius(function(d) { return sector_bottom_pad+d.y; })
            			    .outerRadius(function(d) { return d.y + d.dy; });
            			    
            		 //used for label path
            		var arc_for_label, arc_for_label_number;
            		var arc_label_radius, arc_label_number_radius;
            		if(d.depth==1 && visutil.isLocatedBottom(d)) 
            		{
            			arc_label_radius=d.y + d.dy-(d.y + d.dy-sector_bottom_pad-d.y)/6; 
            			arc_label_number_radius=d.y + d.dy-(d.y + d.dy-sector_bottom_pad-d.y)/8; 
            		}
            		else {
            			arc_label_radius= sector_bottom_pad+d.y+(d.y + d.dy-sector_bottom_pad-d.y)*5/12;
            			arc_label_number_radius=d.y + d.dy-(d.y + d.dy-sector_bottom_pad-d.y)/7;
            		}
            			
            		
            		var bottom = visutil.isLocatedBottom(d);
            		if (bottom) {
            			//special reversed label for bottom data
                      	arc_for_label = visutil.arc(d.x + d.dx-right_pad-Math.PI/2, d.x-Math.PI/2, arc_label_radius);
                      	arc_for_label_number = visutil.arc(d.x + d.dx-right_pad-Math.PI/2, d.x-Math.PI/2, arc_label_number_radius);
            		} else {
                    	
            		 arc_for_label = d3.svg.singleArc()
            		   	.startAngle(function(d) {return d.x; })
            		    .endAngle(function(d) { return d.x + d.dx-right_pad; })
            		    .radius(function(d) { return d.depth==1? d.y + d.dy-(d.y + d.dy-sector_bottom_pad-d.y)/3: sector_bottom_pad+d.y+(d.y + d.dy-sector_bottom_pad-d.y)*3/5; });
            			
            		 arc_for_label_number =  d3.svg.singleArc()
            		   	.startAngle(function(d) {return d.x; })
            		    .endAngle(function(d) { return d.x + d.dx-right_pad; })
            		    .radius(function(d) { return d.depth==1? d.y + d.dy-(d.y + d.dy-sector_bottom_pad-d.y)/3: sector_bottom_pad+d.y+(d.y + d.dy-sector_bottom_pad-d.y)/5; });
                    
                    }  
                    
                     d.coloridx=0;
                     
                     if (d.depth==1 || d.depth==0) {
                    	 d.coloridx=d.id;
                     } else {
                    	 d.coloridx=d.parent.coloridx;
                     }
                     
                     var arc1color;
              		if (d.coloridx=="personality") arc1color=_widget.COLOR_PALLETTE[0];     	
           	     	if (d.coloridx=="needs") arc1color=_widget.COLOR_PALLETTE[1];
           	     	if (d.coloridx=="values") arc1color=_widget.COLOR_PALLETTE[2];
           	     	if (d.coloridx=="sr") arc1color=_widget.COLOR_PALLETTE[3];
           	     	if (d.coloridx=="sbh") arc1color=_widget.COLOR_PALLETTE[4];
           	     	if (d.coloridx=="blank") arc1color=_widget.COLOR_PALLETTE[6];
                         
                     arc1color=d.depth<2 ? arc1color : d3.rgb(arc1color).brighter(Math.pow(1.1,d.depth*1.5));
                     
               	     var strokecolor= d3.rgb(arc1color).darker(0.8);
                     
               	     
                   if(!d.children && d.id!="srasrt"&& d.id!="srclo" && d.id!="srdom" ){
                       var label=d.name;
                       var bar_length_factor=10/(d.depth-2);
                    	
                       var percentage=d.percentage;	
                    	
                    	
                    	//different bar_length factors
                      if (d.parent)    
                      if (d.parent.parent) {
                      	
            	          	if (d.parent.parent.id=="needs"||d.parent.parent.id=="values") { 
            	          		bar_length_factor=1;
        	          		}

            	          	if (d.parent.parent.id=="sbh")	{
            	          		//alert(d.name);
            	          		bar_length_factor=0;
            	          		if (percentage>1) { 
            	          			percentage=Math.random();
            	          			d.percentage=percentage;
            	          		}
            	          	}
            		        if (d.parent.parent.parent) 
            		        	if (d.parent.parent.parent.id=="personality") bar_length_factor=1;
            	          	
                       } else {
                    	   console.log(d.name+": Parent is null!");
                       }
                      
                   
                    	
                    	var     inner_r=sector_bottom_pad+d.y,
                    			out_r;
                    			
            		     			
            				out_r=sector_bottom_pad+d.y+bar_length_factor*Math.abs(percentage)*d.dy;
            			
            			if (d.percentage_lbl=="Low") out_r=sector_bottom_pad+d.y+bar_length_factor*0.2*d.dy;
            			
            			
                    	var _bar = d3.svg.arc()
            					    .startAngle(d.x)
            					    .endAngle(d.x + d.dx)
            					    .innerRadius(inner_r)
            					    .outerRadius(out_r); // Draw leaf arcs
            		
            			
            			 g.append("path")
            		          .attr("class", "_bar")
            		          .attr("d", _bar)
            		          .style("stroke", "#EEE")
            		          .style("fill", function (d) {
            		          		return d3.rgb(arc1color).darker(0.5);
            		          }); 
            	         
            	         
            	         
            	          //add label;
            	          
                      	var rotate=0,
            				lbl_anchor="start",
            				dy_init=0,
            				label=d.name;
            			
            			if (d.x>Math.PI) {
            					rotate=d.x*180/Math.PI+90;
            					lbl_anchor="end";
            					dy_init=-d.dx*20*Math.PI;
    					} else {
            				rotate=d.x*180/Math.PI-90;
            				lbl_anchor="start";
            					dy_init=5+d.dx*20*Math.PI;
        				}
            				
            			var max_label_size=13, lable_size=10;
            			
            			if ((7.5+15*Math.PI*d.dx)>max_label_size) {
            				lable_size=max_label_size;
            			} 			
            				
            	        label=label+" ("+(percentage*100).toFixed(0)+"%)";

            	             
            	        g.append("text")
            			      .attr("dy", dy_init)
            			      .attr("class","sector_leaf_text")
            			      .attr("font-size", lable_size)
            			      .attr("text-anchor", lbl_anchor)
            			      .attr("transform", "translate("+(out_r+5)*Math.sin(d.x)+","+(-(out_r+5)*Math.cos(d.x))+") "+"rotate("+rotate+")") 
            			      .text(label);
                    	
                    } else {   
                     //non-bar/non-leaf sector        
            		      g.append("path")
            		          .attr("class", "arc1")
            		          .attr("d", arc1)
            		          .style("stroke", strokecolor) // was: arc1color
            		          .style("fill", arc1color );
            		         
            		      	    
            		       g.append("path")
            		          .attr("class", "arc2")
            		          .attr("d",arc2)
            		          .style("stroke", strokecolor) // was: arc1color
            		      	  .style("fill", arc1color )
            		      	  .style("fill-opacity", 0.15 );
                  	    
            				//draw label:
            				//path used for label 	
            				 g.append("path")
            		          .attr("class", "arc_for_label")
            		          // NOTE HB: adding widget.id so we to avoid name clashing            		          
            		          .attr("id",function(d) { return _this.id+"_"+d.id+".arc_for_label"; })
            		           .attr("d", arc_for_label)
            		          .style("stroke-opacity", 0)
            		          .style("fill-opacity", 0 );
            		          
            		       
            		         //add label 
            			     g.append("text")
            				   .attr("class","sector_label")
            			       .attr("visibility", function(d) { return d.depth==1 ? "visible" : null; })
            			       .attr("class","sector_nonleaf_text")
            			       .append("textPath")
            			       	.attr("class","sector_label_path")
            			       	.attr("position-in-sector", d.depth<=1 ? "center" : (bottom ? "inner" : "outer")) // Since both text lines share the same "d", this class annotation tells where is the text, helping to determine the real arc length
            			       	.attr("font-size", function(d) { return 30/Math.sqrt(d.depth+1); })
            			       	// NOTE HB: Why do we need this xlink:href? In any case, adding widget.id so we to avoid name clashing            		          
            			        .attr("xlink:href", function(d) { return "#"+_this.id+"_"+d.id+".arc_for_label"; })
            			        .text(label_name);
            			     
            			     //draw label number
            			     //path used for label number 
            			     if (d.depth>1){
            			    	 g.append("path")
	               		          .attr("class", "arc_for_label_number")
	               		          // NOTE HB: adding widget.id so we to avoid name clashing            		          
	               		          .attr("id",function(d) { return _this.id+"_"+d.id+".arc_for_label_number"; })
	               		           .attr("d", arc_for_label_number)
	               		          .style("stroke-opacity", 0)
	               		          .style("fill-opacity", 0 );
	               		          
	               		       
	               		         //add label 
	               			     g.append("text")
	               				   .attr("class","sector_label_number ")
	               			       .attr("visibility", function(d) { return d.depth==1 ? "visible" : null; })
	               			       //.attr("font-family","sans-serif")
	               			       .attr("class","sector_nonleaf_text")
	               			       //.attr("fill", d3.rgb(arc1color).darker(2))
	               			       .append("textPath")
	               			       	.attr("class","sector_label_number_path")
	               			     	.attr("position-in-sector", bottom ? "outer" : "inner") // Since both text lines share the same "d", this class annotation tells where is the text, helping to determine the real arc length
	               			       	.attr("font-size", function(d) { return 10; })
	               			       	// NOTE HB: Why do we need this xlink:href? In any case, adding widget.id so we to avoid name clashing            		          
	               			        .attr("xlink:href", function(d) { return "#"+_this.id+"_"+d.id+".arc_for_label_number"; })
	               			        .text(label_percentage);
            			     }
            				 
                  	
                  	}  
                });

              }

              return twoArcs;
            };
            
            function updateLabelLayout() {
            	updateLabelLayoutWithClass('.sector_label_path');
            	updateLabelLayoutWithClass('.sector_label_number_path');
            }
            
            function updateLabelLayoutWithClass(_class) {
            	var max_font_size_base=16;
            	var min_font_size_base=9;
            	var margin=10;
            	_this.d3vis.selectAll(_class).each(function(d){
            		var d3this = d3.select(this);
					var curNd = d3this.node();
					var text = d3this.text();
					if(text && text.length>0) {
						var position = d3.select(this).attr('position-in-sector'); // 'inner' or 'outer'
						var frac = position=='center' ? 0.5 : position=='outer' ? 2/3 : 1/3;
						var sector_length=(d.y+d.dy*frac)*d.dx;
						var text_length=curNd.getComputedTextLength(); //+margin;
						var cur_font_size=d3.select(this).attr("font-size");
						var new_font_size=cur_font_size*sector_length/text_length;
						var new_text_length = text_length * new_font_size/cur_font_size;
							//if (d.id=="Openness_parent" || d.id=="personality") {
							if (d.depth==1) {
								console.log("updateLabelLayout ["+d.id+"] '"+text+"', |text|", text_length, "|sec|=", sector_length, "cur_size", cur_font_size, "new_size", new_font_size, "new_text_legth", new_text_length,d, curNd, position);
							}
						if(new_font_size>max_font_size_base/(0.4*d.depth+0.6)) {							
							new_font_size=max_font_size_base/(0.4*d.depth+0.6);
							if (d.depth==1)
								console.log("fixed to", new_font_size);				
						}
						
						d3.select(this).attr("font-size",new_font_size);
						//set new offset:
						d3.select(this).attr("startOffset", (sector_length-curNd.getComputedTextLength())/2);
					}
				});
            };

			function adjustSectorWidth(d) {
				if (!d.anglefactor) d.anglefactor=1;
				if (d3.event.sourceEvent.type == 'DOMMouseScroll' && d3.event.sourceEvent.ctrlKey) {
					//ctrl+mousewheel to adjust sector width				
					if (d3.event.sourceEvent.detail <0) {
						//Increase angle
						d.anglefactor+=angle_factor_increment;
					} else {
						//Decrease angle
					   d.anglefactor=(d.anglefactor-angle_factor_increment)> angle_factor_min ? d.anglefactor-angle_factor_increment: angle_factor_min;
					}
					
					update_anglefactor(d, d.anglefactor);
					g.data(partition.value(function(a) { 			    	
		        		return a.size; 
		        	}))
			        .call(sector);
		     		updateLabelLayout();					
				}
			};
            
        	var width = this.dimW, height = this.dimH;
        	// The flower had a radius of 640 / 1.9 = 336.84 in the original.
        	var radius = Math.min(width, height) / 3.2;
    		var sector = twoArcsRender(radius);

        	var vis = this.d3vis.append("g")
    	    	.attr("transform", "translate(" + (width / 2)+ "," + height / 2 + ")") //center the graph of "g"
    	    	.append("g")
        	this.vis = vis;  
        	
        	var partition = d3.layout.partition()
	    	    .sort(null)
	    	    .size([2 * Math.PI, radius])
	    	    .value(function(d) { return d.size; });

        	var profile = tree;
        	
			var g = vis.data([profile]).selectAll("g")
			    .data(partition.nodes)
			    .enter().append("g")
			    .attr("class", "sector")
			    .attr("visibility", function(d) { return d.depth==2 || d.forceVisible ? "visible" : "hidden"; }) // hide non-first level rings
			    .call(sector)
			    .each(stash)
			    .on("click", expandOrFoldSector)
			    .on("mouseover", function(d) {
			    	_this.showTooltip(d, this);
			    })
			    .on("mouseout", function(d) {
			    	_this.showTooltip();
			    })
			    .call(d3.behavior.zoom().on("zoom", adjustSectorWidth))
			    ;
			
			// Shift the text pieces clockwise (to somewhat center them).
			updateLabelLayout();
        };
   	
	</script>
	
	<div class="changeMe"></div>
	<script>
		// Trigger render
        d3.select('.changeMe').attr("id", widgetId).classed({'chartDiv': true, 'changeMe': false});
	 	var d3vis = d3.select("#"+widgetId).append("svg:svg");
	 	var widget = {
	 		d3vis: d3vis,
	 		data: theProfile,
	 		loadingDiv: "dummy",
	 		switchState: function() { console.log("[switchState]");},
	 		_layout:     function() { console.log("[_layout]"); },
	 		showTooltip: function() { console.log("[showTooltip]"); },
	 		id: "SystemUWidget",
	        COLOR_PALLETTE: ["#1b6ba2","#488436","#d52829","#F53B0C","#972a6b","#8c564b","#dddddd"],
           	expandAll: function() {
	    		this.vis.selectAll("g").each(function(d, i) {
	    			var g = d3.select(this);
	    			if(g.datum().parent != null && // Isn't the root g object.
	    				g.datum().parent.parent != null && // Isn't the feature trait.
						g.datum().parent.parent.parent != null) {// Isn't the feature dominant trait.
						g.attr("visibility", "visible");
					};
	    		});
    		},
    		collapseAll: function() {
                this.vis.selectAll("g").each(function(d, i) {
                    var g = d3.select(this);
                    if(g.datum().parent != null && // Isn't the root g object.
                        g.datum().parent.parent != null && // Isn't the feature trait.
                        g.datum().parent.parent.parent != null) {// Isn't the feature dominant trait.
                        g.attr("visibility", "hidden");
                    };
                });
    		},
            addPersonImage: function(url) {
                if (!this.vis || !url) {
                    return;
                }
                var icon_defs = this.vis.append("defs");
                var width = this.dimW, height = this.dimH;
                
                // The flower had a radius of 640 / 1.9 = 336.84 in the original, now is 3.2.
                var radius = Math.min(width, height) / 16.58; // For 640 / 1.9 -> r = 65
                var scaled_w = radius * 2.46; // r = 65 -> w = 160
                
                var id = "user_icon_"+this.id;
                icon_defs.append("pattern")
                    .attr("id", id)
                    .attr("height",1)
                    .attr("width",1)
                    .attr("patternUnits","objectBoundingBox")
                        .append("image")
                            .attr("width", scaled_w) 
                            .attr("height", scaled_w)
                            .attr("x", radius - scaled_w/2) // r = 65 -> x = -25
                            .attr("y", radius - scaled_w/2)    
                            .attr("xlink:href", url)
                            .attr("opacity", 1.0)
                            .on("dblclick.zoom", null);
                this.vis.append("circle")
                    .attr("r",radius)
                    .attr("stroke-width",0)
                    .attr("fill","url(#"+id+")");           
            }
	 	};
	 	
	 	widget.dimH = widgetHeight;
	 	widget.dimW = widgetWidth;
	 	widget.d3vis.attr("width", widget.dimW).attr("height", widget.dimH);
	 	renderChart.call(widget);
	 	widget.expandAll.call(widget);
        if (personImageUrl) widget.addPersonImage.call(widget, personImageUrl);
	</script>
